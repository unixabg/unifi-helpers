#!/bin/bash

# Usage:
#   Single mode:
#     ./unifi-vlan-reboot --ip <SWITCH_IP> --username <SSH_USER> --port <PORT> [--key <id_rsa>]
#
#   Batch mode (file):
#     ./unifi-vlan-reboot --file devices.txt [--key <id_rsa>]
#       where each line is: <SWITCH_IP> <SSH_USER> <PORT>

# ---------- Password handling ----------
# If outer script set DEVICES_SSH_PASSWORD, use it
if [[ -n "$DEVICES_SSH_PASSWORD" ]]; then
    SSH_PASSWORD="$DEVICES_SSH_PASSWORD"
fi

# If still empty, maybe user exported SSH_PASSWORD manually
SSH_PASSWORD="${SSH_PASSWORD:-}"

# ----------- Argument Parsing (long options) -----------
SWITCH_IP=""
SSH_USER=""
PORT=""
DEVICE_FILE=""
SSH_KEY=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        --ip)
            SWITCH_IP="$2"
            shift 2
            ;;
        --username|--user)
            SSH_USER="$2"
            shift 2
            ;;
        --port)
            PORT="$2"
            shift 2
            ;;
        --file)
            DEVICE_FILE="$2"
            shift 2
            ;;
        --key)
            SSH_KEY="$2"
            shift 2
            ;;
        -h|--help)
            echo "Usage:"
            echo "  Single mode:"
            echo "    $0 --ip <SWITCH_IP> --username <SSH_USER> --port <PORT> [--key <id_rsa>]"
            echo
            echo "  Batch mode:"
            echo "    $0 --file devices.txt [--key <id_rsa>]"
            exit 0
            ;;
        *)
            echo "Unknown argument: $1"
            exit 1
            ;;
    esac
done

# ---------- Function for password if no keyfile ----------
prompt_for_password() {
    # Only needed if we're NOT using a key
    if [[ -n "$SSH_KEY" ]]; then
        return
    fi

    if [[ -z "$SSH_PASSWORD" ]]; then
        read -s -p "SSH Password: " SSH_PASSWORD
        echo
    fi
    export SSHPASS="$SSH_PASSWORD"
}

# ---------- Function to act on one device/port ----------
run_one() {
    local SWITCH_IP="$1"
    local SSH_USER="$2"
    local PORT="$3"

    if [[ -z "$SWITCH_IP" || -z "$SSH_USER" || -z "$PORT" ]]; then
        echo "Skipping invalid line: '$SWITCH_IP $SSH_USER $PORT'" >&2
        return
    fi

    echo "Processing: $SWITCH_IP $SSH_USER $PORT"

    if [[ -n "$SSH_KEY" ]]; then
        # Key-based auth
        ssh -i "$SSH_KEY" -n \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$SWITCH_IP" \
            "swctrl poe restart id $PORT"
    else
        # Password-based auth via sshpass
        sshpass -e ssh -n \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$SWITCH_IP" \
            "swctrl poe restart id $PORT"
    fi
}

# ----------- Execution Mode Detection -----------

# Batch mode
if [[ -n "$DEVICE_FILE" ]]; then
    if [[ ! -f "$DEVICE_FILE" ]]; then
        echo "Device file not found: $DEVICE_FILE"
        exit 1
    fi

    # Only prompt if not using key
    prompt_for_password

    # ----------- Batch Mode Loop -----------
    while IFS=' ' read -r FILE_IP FILE_USER FILE_PORT; do
        # Skip empty lines / comments
        [[ -z "$FILE_IP" ]] && continue
        [[ "$FILE_IP" =~ ^# ]] && continue

        run_one "$FILE_IP" "$FILE_USER" "$FILE_PORT"
    done < "$DEVICE_FILE"

    echo "Done."
    # Cleanup
    unset SSHPASS
    unset SSH_PASSWORD
    exit 0
fi

# Single mode
if [[ -z "$SWITCH_IP" || -z "$SSH_USER" || -z "$PORT" ]]; then
    echo "Missing required arguments."
    echo "Run with --help for usage."
    exit 1
fi

prompt_for_password
run_one "$SWITCH_IP" "$SSH_USER" "$PORT"

# Cleanup
unset SSHPASS
unset SSH_PASSWORD
echo "Done."

