#!/bin/bash

# Usage:
#   Batch mode (file):
#     ./unifi-vlan-reboot devices.txt
#       where each line is: <SWITCH_IP> <SSH_USER> <PORT>
#
#   Single mode:
#     ./unifi-vlan-reboot <SWITCH_IP> <SSH_USER> <PORT>

# ---------- Password handling ----------
# If outer script set DEVICES_SSH_PASSWORD, use it
if [[ -n "$DEVICES_SSH_PASSWORD" ]]; then
    SSH_PASSWORD="$DEVICES_SSH_PASSWORD"
fi

# If still empty, maybe user exported SSH_PASSWORD manually
SSH_PASSWORD="${SSH_PASSWORD:-}"

# We'll prompt *once* if still empty, before running anything
prompt_for_password() {
    if [[ -z "$SSH_PASSWORD" ]]; then
        read -s -p "SSH Password: " SSH_PASSWORD
        echo
    fi
    export SSHPASS="$SSH_PASSWORD"
}

# ---------- Function to act on one device/port ----------
run_one() {
    local SWITCH_IP="$1"
    local SSH_USER="$2"
    local PORT="$3"

    if [[ -z "$SWITCH_IP" || -z "$SSH_USER" || -z "$PORT" ]]; then
        echo "Skipping invalid line: '$SWITCH_IP $SSH_USER $PORT'" >&2
        return
    fi

    echo "Processing: $SWITCH_IP $SSH_USER $PORT"

    sshpass -e ssh -n -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$SSH_USER@$SWITCH_IP" \
        "swctrl poe restart id $PORT"
}

# ---------- Batch mode (file) ----------
if [[ -f "$1" && "$#" -eq 1 ]]; then
    INPUT_FILE="$1"
    prompt_for_password

    # Loop over every non-empty line: <IP> <USER> <PORT>
    while read -r IP USER PORT; do
        # Skip blank lines
        [[ -z "$IP" ]] && continue

        run_one "$IP" "$USER" "$PORT"
    done < "$INPUT_FILE"

    echo "Done with file run."
    # Cleanup
    unset SSHPASS
    unset SSH_PASSWORD
    exit 0
fi

# ---------- Single mode (3 args) ----------
if [[ "$#" -ne 3 ]]; then
    echo "Usage:"
    echo "  $0 devices.txt"
    echo "  OR"
    echo "  $0 <SWITCH_IP> <SSH_USER> <PORT>"
    exit 1
fi

SWITCH_IP="$1"
SSH_USER="$2"
PORT="$3"

prompt_for_password
run_one "$SWITCH_IP" "$SSH_USER" "$PORT"

# Cleanup
unset SSHPASS
unset SSH_PASSWORD
echo "Done."

